---
title: "Preparation of Technology Catalogue for MOPO EU/ Industrial Cluster Case Study"
subtitle: "AIDRES, JRC-IDEES, EUROSTAT"
date: last-modified
date-format: long
author: 
 - name: Partha Das
   affiliation: 
    - name: 'VITO'
      url: https://vito.be/nl
 - name: Pieter Valkering
   affiliation: 
    - name: 'VITO'
      url: https://vito.be/nl
 - name: Hans Van de Put
   affiliation: 
    - name: 'VITO'
      url: https://vito.be/nl
format: 
  html:
    code-fold: true
    code-summary: "Show the code"
    toc: true
    theme: journal
bibliography: references.bib
keywords:
  - AIDRES
  - EUROSTAT
  - JRC-IDEES
license: "CC BY"
citation: true
funding: 
  statement: "EU Project MOPO"
---

# Introduction

This is a stand-alone quarto document with code chunks and documentation for an application preparing raw input data for MOPO EU/ Industrial cluster case study directly from AIDRES database.


# Using the application

The files are produced using [R](https://cran.r-project.org/) and [RStudio](https://posit.co/download/rstudio-desktop/).
Though the scripts can be executed using command line, it is recommended to use `RStudio` for rendering.

Clone this [repository](https://git.vito.be/scm/sesam/mopo_repo.git) in your computer. Open the `mopo_repo.Rproj` (`RStudio needs to be installed`) file. Open `refinery_analysis.qmd` and click on `render button` (Crtl + Shift + K).


# Loading libraries

The application checks whether the required packages for running the scripts are installed or not. If not, it automatically installs them and loads them. If they are already installed, it just loads them.

```{r}
#| warning: false

mypackages <- c('tidyverse', 'readxl', 'janitor', 'archive', 'DBI', 'odbc',
                'RPostgres', 'eurostat', 'stringr', 'forcats', 'writexl', 
                'xlsx', 'gt', 'here', 'giscoR', 'sf')

for (p in mypackages) {
  if (!require(p, character.only = TRUE)) {
    if (p == "sf") {
      install.packages(p, type = "binary")
    } else {
      install.packages(p)
    }
    library(p, character.only = TRUE)
  }
}
```


# Reading AIDRES data

## Establishing AIDRES database connection and fetching tables (not used)

AIDRES database is open source [@aidres_report]. However the data is [available](https://jeodpp.jrc.ec.europa.eu/ftp/jrc-opendata/EIGL-Data/AIDRES/) as a raw `.sql` file which needs to be further used to setup a PostgreSQL database connection to fetch various tables. The data is also available as an Excel workbook. However, it is very customized to be used for specific analysis.

In VITO we have set up a AIDRES postgreSQL database server. The following codes chunks are used to fetch the tables dynamically for the analysis.Username and password is not explicitly mentioned due to security reasons; they are read from a local R env profile file. For a different computer a separate profile files needs to be used.

These code chunks are currently deactivated, because we work with an updated version of the AIDRES database (AIDRES 2.0).

```{r}
#| eval: false

con <- dbConnect(RPostgres::Postgres(),
                 host = "kaartenbak.marvin.vito.local",
                 dbname = "zandbakken",
                 user = Sys.getenv("user"),
                 password = Sys.getenv("password"),
                 port = 5432
)
```

Fetching tables from AIDRES database (currently deactivated)

```{r}
#| eval: false

aidres_scenarios <- tbl(con, dbplyr::in_schema('aidres','model_scenario'))
aidres_sectors <- tbl(con, dbplyr::in_schema('aidres','aidres_sectors'))  
aidres_result <- tbl(con, dbplyr::in_schema('aidres','model_results')) 
aidres_configurations <- tbl(con, dbplyr::in_schema('aidres','model_configurations')) 
aidres_perton <- tbl(con, dbplyr::in_schema('aidres','model_perton')) 
```


## Importing AIDRES 2.0 data from local `.csv` files

We use an updated version of the AIDRES database (AIDRES 2.0), in which the production capacities of the chemical sector have been revised for both the Netherlands (based on Midden: https://www.pbl.nl/en/publications/manufacturing-industry-decarbonisation-data-exchange-network) and Flanders (based on the GPBV database: https://omgeving.vlaanderen.be/nl/omgevingsvergunning/meer/overzicht-gpbv-installaties-in-vlaanderen-industrie). This update was particularly important for the Netherlands, as the original AIDRES database did not include Chemelot. For the Netherlands actually not only the chemical sector, but also all other AIDRES sectors are updated based on Midden where necessary.

The AIDRES 2.0 tables are included in this repository under input_data/aidres_data and consist of:
aidres_2_0_scenarios.csv
aidres_2_0_sectors.csv
aidres_2_0_result.csv
aidres_2_0_configurations.csv
aidres_2_0_perton.csv

This chunk of code reads the AIDRES 2.0 data `.csv` files. 

```{r}
#| warning: false
aidres_data <- here('input_data', 'aidres_data')


aidres_2_0_sectors <- read_csv2(here(aidres_data, 'aidres_2_0_sectors.csv'))

aidres_2_0_results <- read_delim(here(aidres_data, "aidres_2_0_results.csv"),
                                 delim = ";",
                                 locale = locale(decimal_mark = ".", grouping_mark = ","),
                                 guess_max = 6000)

aidres_2_0_configurations <- read_csv2(here(aidres_data, 'aidres_2_0_configurations.csv'))

aidres_2_0_products <- read_csv2(here(aidres_data, 'aidres_2_0_products.csv'))


aidres_2_0_perton <- read_delim(here(aidres_data, "aidres_2_0_perton.csv"),
                                 delim = ";",
                                 locale = locale(decimal_mark = ".", grouping_mark = ","),
                                 guess_max = 6000)
```


# Get additional data

Get data on the CO2 consumption for the co electrolysis processes in AIDRES (based on Figure 12 and 13 of the final aidres report). For (COEL)FT-MEA, (COEL)MeOH-MEA, CO2 consumption in the final aidres report is expressed in ton CO2/t LLF, which is converted to ton CO2/MWh LLF based on a lower heating value of 11.91 MWh/t. For ((COEL)MeOH)O-MEA, ton CO2/ton LLF is converted to ton CO2/ton olefins by dividing by 2.15 (ton MeOH/ton LLF) and by (0.41 ton olefins/ton MeOH).

Get additional data for the new hydrogen to Fischer-Tropsch and hydrogen to methanol processes from the Danish technology catalogue (https://ens.dk/en/analyses-and-statistics/technology-catalogues): ‘Hydrogen to Jet’ and ‘Methanol from hydrogen and carbon dioxide’. 

For the ‘Hydrogen to Jet’ process, the capex is expressed in Meur_(MW_FT)_year, which is converted to (eur-yr)/mwh by multiplying by 1000000 eur/Meur and dividing by 8760 h/y. The fom already has the correct unit.

For the ‘Methanol from hydrogen and carbon dioxide’, the capex is expressed in Meur_(MW_methanol), which is converted to (eur-yr)/mwh by multiplying by 1000000 eur/Meur and dividing by 8760 h/y. The fom is expressed in 'keur_(MW_methanol_year)', which is multiplied by 1000 eur/keur and divided by 8760 h/year to convert to eur/mwh. 

Check the 'extra_data_processed.xlsx' file (tab 'calculations') for more info on the calculations.

```{r}
file_extra_data <- here('input_data', 'extra_data')
extra_data_processes <- read_xlsx(here(file_extra_data, 'extra_data_processes.xlsx'), sheet = 'extra_data', range = 'A1:K20')
```

Get production data for Switzerland, Norway and the UK retrieved from reports, websites or literature. More information on the data source can be found in the 'Mopo_Data_Collection_CH_NO_UK.xlsx' file.
```{r}
extra_data_production <- read_xlsx(here(file_extra_data, 'Mopo_Data_Collection_CH_NO_UK.xlsx'), sheet = 'extra_data_CH_NO_UK', range = 'A1:N170')
```

# AIDRES data for MOPO EU/ Industrial cluster case study

Important general remarks:
- Processing AIDRES 2.0 data to construct tables for the technology catalogue. To limit the number of production routes for the analysis we only select AIDRES 2.0 routes that are in the AIDES 2040 mix 
- Both nitric acid and urea related data are not extracted from AIDRES 2.0, because of the risk of double counting the energy use for ammonia production.
- Energy use is converted from pJ to MWh
- For refineries, we are interested in the production of HC in MWh (not ton). Therefore ton HC is converted to MWh HC

## Specific energy consumption factors

```{r}
extra_data_processes |> 
  filter(parameter == 'sec') |>
  select('sector_id', 'Industry', 'from_node', 'to_node', 'unit', '2025', '2030', '2040', '2050') ->
  extra_data_filtered
      
aidres_2_0_configurations$configuration <- gsub(" ", "_", aidres_2_0_configurations$configuration)

aidres_2_0_perton |> clean_names() |>
  select(scenario_id:is_reference_route, contains('_usage_pj_t')) |>
  pivot_longer(alternative_fuel_mixture_usage_pj_t:natural_gas_usage_pj_t, names_to = 'indicators', values_to = 'gj_t') |>
  filter((horizon == 2030 & scenario_id == 1) | horizon == 2018) |>
  left_join(aidres_2_0_configurations |>select(configuration_id, mix_2018:mix_2050), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_configurations |>select(configuration_id, configuration), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_sectors, by =join_by('sector_id' == 'sector_id')) |>
  left_join(aidres_2_0_products, by = join_by('product_id' == 'product_id')) |>
  filter(
    (is_reference_route == 1 & scenario_id == 0 & product_id != 12 & product_id != 13) | 
      (mix_2040 != 0 & !grepl('mix', configuration) & product_id != 12 & product_id != 13) |
      (configuration_id == 221) | (configuration_id == 241)) |>
  select(sector, product, configuration, indicators, gj_t) |>
  rename(sector_id = sector) |>
  rename(product_id = product) |>
  distinct() |>
  pivot_wider(names_from = indicators, values_from = gj_t) |>
  mutate(
    coal = rowSums(cbind(coal_usage_pj_t, coke_usage_pj_t, coal_steel_usage_pj_t), na.rm = TRUE),
    bio = rowSums(cbind(biomass_usage_pj_t, biomass_waste_usage_pj_t), na.rm = TRUE),
    waste = rowSums(cbind(plastic_mix_usage_pj_t, alternative_fuel_mixture_usage_pj_t), na.rm = TRUE),
    HC = rowSums(cbind(crude_oil_usage_pj_t, naphtha_usage_pj_t), na.rm = TRUE), .keep = 'unused') |> 
  rename(
    'NH3' = ammonia_usage_pj_t,
    'elec' = electricity_usage_pj_t,
    'H2' = hydrogen_usage_pj_t,
    'MeOH' = methanol_usage_pj_t,
    'CH4' = natural_gas_usage_pj_t) |> 
  pivot_longer(H2:HC, names_to = 'commodity', values_to = 'gj_t') |>
  mutate(gj_t = gj_t * 1000000,
         sector_id = tolower(sector_id)) |>
  rename(
    'to_node' = product_id,
    'from_node' = commodity,
    'Industry' = configuration) |>
  mutate(sector_id = tolower(sector_id)) |>
  mutate(mwh_t = round((gj_t * 0.277),5), .keep = 'unused') ->  sec_perton_all
sec_perton_all
sec_perton_all[sapply(sec_perton_all, is.infinite)] <- 0

sec_perton_all_2025 <- sec_perton_all |> mutate(year = 2025)
sec_perton_all_2030 <- sec_perton_all |> mutate(year = 2030)
sec_perton_all_2040 <- sec_perton_all |> mutate(year = 2040)
sec_perton_all_2050 <- sec_perton_all |> mutate(year = 2050)

rbind(sec_perton_all_2025, sec_perton_all_2030, sec_perton_all_2040, sec_perton_all_2050) |> 
  pivot_wider(values_from = mwh_t, names_from = year) |> 
  mutate(unit = 'mwh_t') |> 
  select(sector_id:to_node, unit, everything()) -> sec_perton_all

# for refineries, we want the product in MWh (1 ton HC = 11.92 MWh)
# change glass production routes names

sec_perton_all |> 
  mutate(to_node = case_when(sector_id == 'refineries'~ 'HC',
                             .default = to_node)) |>
  mutate(from_node = case_when((sector_id == 'refineries' & from_node == 'HC')~ 'crude',
                             .default = from_node)) |> 
  pivot_longer(cols = `2025`:`2050`, names_to = 'year', values_to = 'value') |> 
  mutate(value = case_when(sector_id == 'refineries' ~ round(value / 11.92,5),
                           .default = value)) |> 
  mutate(unit = case_when(sector_id == 'refineries' ~ 'mwh_mwh',
                           .default = 'mwh_t')) |> 
  mutate(Industry = case_when(to_node == 'glass-container'~ paste0(Industry, '_gco'),
                              to_node == 'glass-fibre'~ paste0(Industry, '_gfi'),
                              to_node == 'glass-float'~ paste0(Industry, '_gfl'),
                              .default = Industry)) |>
  pivot_wider(names_from = year, values_from = value) |>
  bind_rows(extra_data_filtered) |>
  mutate(to_node = if_else(Industry %in% c("(H2)MeOH-DC", "(BM)MeOH", "(COEL)MeOH-MEA"), "HC-MeOH", to_node)) |>
  mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node)) |>
  filter(!(`2025` < 0.0000001 | `2030` < 0.0000001 | `2040` < 0.0000001 | `2050` < 0.0000001))-> sec_perton_all

sec_perton_all
```

## Costs: capex and fom

Important remarks:
- The cost figures from AIDRES 2.0 (in EUR2018) and from the Danish Technology Catalogue (in EUR2020) are converted to EUR2025 using historical inflation rates.
- Annualized CAPEX values are converted to total CAPEX using a capital recovery factor based on a 6% interest rate. For all routes the lifetime of the original source is retained.

```{r}
extra_data_processes |> 
  filter(parameter == 'fom') |>
  select('sector_id', 'Industry', 'to_node', 'parameter', 'unit', '2025', '2030', '2040', '2050') |>
  mutate(`2025` = `2025` * 1.026 * 1.084 * 1.054 * 1.024 * 1.021) |>
  mutate(`2030` = `2030` * 1.026 * 1.084 * 1.054 * 1.024 * 1.021) |>
  mutate(`2040` = `2040` * 1.026 * 1.084 * 1.054 * 1.024 * 1.021) |>
  mutate(`2050` = `2050` * 1.026 * 1.084 * 1.054 * 1.024 * 1.021) |>
  rename('costs' = 'parameter') -> extra_data_fom_filtered

extra_data_processes |> 
  filter(parameter == 'capex') |>
  select('sector_id', 'Industry', 'to_node', 'parameter', 'unit', '2025', '2030', '2040', '2050') |>
  mutate(`2025` = `2025` * 1.026 * 1.084 * 1.054 * 1.024 * 1.021) |>
  mutate(`2030` = `2030` * 1.026 * 1.084 * 1.054 * 1.024 * 1.021) |>
  mutate(`2040` = `2040` * 1.026 * 1.084 * 1.054 * 1.024 * 1.021) |>
  mutate(`2050` = `2050` * 1.026 * 1.084 * 1.054 * 1.024 * 1.021) |>
  rename('costs' = 'parameter')  -> extra_data_capex_filtered

int_rate <- .06
life_40 <- 40
life_30 <- 30
life_25 <- 25
crf_40 <- (int_rate*(1+int_rate)^life_40)/((1+int_rate)^life_40 - 1)
crf_30 <- (int_rate*(1+int_rate)^life_30)/((1+int_rate)^life_30 - 1)
crf_25 <- (int_rate*(1+int_rate)^life_25)/((1+int_rate)^life_25 - 1)

aidres_2_0_perton |> clean_names() |>
  select(scenario_id:is_reference_route, contains('eur_t')) |>
  pivot_longer(opex_var_eur_t:capex_eur_t, names_to = 'indicators', values_to = 'eur_t') |>
  filter((horizon == 2030 & scenario_id == 1) | horizon == 2018) |>
  left_join(aidres_2_0_configurations |>select(configuration_id, mix_2018:mix_2050), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_configurations |>select(configuration_id, configuration), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_sectors, by =join_by('sector_id' == 'sector_id')) |>
  left_join(aidres_2_0_products, by = join_by('product_id' == 'product_id')) |>
  filter(
    (is_reference_route == 1 & scenario_id == 0 & product_id != 12 & product_id != 13) | 
    (mix_2040 != 0 & !grepl('mix', configuration) & product_id != 12 & product_id != 13 & is_reference_route != 1 & scenario_id != 0) |
    (configuration_id == 221) | (configuration_id == 241)) |>
  select(sector, product, configuration, indicators, eur_t) |>
  rename(sector_id = sector) |>
  rename(product_id = product) |>
  distinct() |>
  pivot_wider(names_from = indicators, values_from = eur_t) |>
  rename('capex' = capex_eur_t,
         'fom' =  opex_cst_eur_t,
         'vom' = opex_var_eur_t) |> 
  pivot_longer(capex:vom, names_to = 'costs', values_to = 'eur_t') |> 
  mutate(eur_t = round(eur_t,3)) |> 
  rename('to_node' = product_id,
         'Industry' = configuration) |> 
  mutate(sector_id = tolower(sector_id)) |>
  select(sector_id, Industry, to_node, everything()) -> costs_perton_all


costs_perton_all |>
  filter(costs == "capex") |>
  mutate(eur_t = round(
    eur_t / case_when(
      #Industry == "ethane_cracker_H2+CH4" ~ crf_30,
      #Industry == "ethane_cracker_H2+CH4_with_CCS" ~ crf_30,
      Industry == "(H2)FT-DC" ~ crf_25,
      Industry == "(H2)MeOH-DC" ~ crf_30,
      Industry == "Diaphragm" ~ crf_30,
      TRUE            ~ crf_40       # default for all other industries
    ),
    3
  )) -> capex_perton_all

costs_perton_all |> filter(costs == 'fom') -> fom_perton_all

rbind(capex_perton_all, fom_perton_all) -> costs_perton_all

# Capex and cst opex is multiplied with historical inflation rate
# Inflation rates: 2018, 1.8,; 2019, 1.2; 2020,0.3; 2021,2.6; 2022,8.4; 2023,5.4; 2024,2.4; projected 2025,2.1
costs_perton_all_2025 <- costs_perton_all |> mutate(year = 2025, eur_t = eur_t*1.012*1.003*1.026*1.084*1.054*1.024*1.021)
costs_perton_all_2030 <- costs_perton_all |> mutate(year = 2030, eur_t = eur_t*1.012*1.003*1.026*1.084*1.054*1.024*1.021)
costs_perton_all_2040 <- costs_perton_all |> mutate(year = 2040, eur_t = eur_t*1.012*1.003*1.026*1.084*1.054*1.024*1.021)
costs_perton_all_2050 <- costs_perton_all |> mutate(year = 2050, eur_t = eur_t*1.012*1.003*1.026*1.084*1.054*1.024*1.021)

rbind(costs_perton_all_2025, costs_perton_all_2030, costs_perton_all_2040, costs_perton_all_2050) |> 
  pivot_wider(values_from = eur_t, names_from = year) |> 
  mutate(unit = case_when(costs == 'capex'~ 'eur-yr_t',
                          costs == 'fom' ~ 'eur_t',
                          costs =='vom' ~ 'eur_t')) |> 
  select(sector_id:costs, unit, everything()) -> costs_perton_all


# for refineries, we want the product in MWh (1 ton HC = 11.92 MWh)
# change glass production routes names

costs_perton_all |>
  mutate(to_node = case_when(sector_id == 'refineries'~ 'HC',
                             .default = to_node)) |>
  pivot_longer(cols = `2025`:`2050`, names_to = 'year', values_to = 'value') |>
  mutate(value = case_when(sector_id == 'refineries' ~ value/11.92,
                           .default = value)) |>
  mutate(Industry = case_when(to_node == 'glass-container'~ paste0(Industry, '_gco'),
                              to_node == 'glass-fibre'~ paste0(Industry, '_gfi'),
                              to_node == 'glass-float'~ paste0(Industry, '_gfl'),
                              .default = Industry)) |>
pivot_wider(names_from = year, values_from = value) -> costs_perton_all

costs_capex_perton_all <- costs_perton_all |> 
                          filter(costs == 'capex') |>
                          bind_rows(extra_data_capex_filtered) |>
                          mutate(unit = case_when(sector_id == 'refineries' ~ 'eur-yr_mwh',
                            .default = 'eur-yr_t')) |>
                          mutate(to_node = if_else(Industry %in% c("(H2)MeOH-DC", "(BM)MeOH", "(COEL)MeOH-MEA"), "HC-MeOH", to_node)) |>
                          mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node))
costs_capex_perton_all

costs_fom_perton_all <- costs_perton_all |> 
                        filter(costs == 'fom') |>
                        bind_rows(extra_data_fom_filtered) |>
                        mutate(unit = case_when(sector_id == 'refineries' ~ 'eur_mwh',
                          .default = 'eur_t')) |>
                        mutate(to_node = if_else(Industry %in% c("(H2)MeOH-DC", "(BM)MeOH", "(COEL)MeOH-MEA"), "HC-MeOH", to_node)) |>
                        mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node))

costs_fom_perton_all
```

## CO2 emissions and capture

```{r}
extra_data_processes |> 
  filter(parameter == 'co2_capture') |>
  select('sector_id', 'Industry', 'to_node', 'parameter', 'unit', '2025', '2030', '2040', '2050') |>
  rename('emission' = 'parameter') -> extra_data_co2_capture_filtered

extra_data_processes |> 
  filter(parameter == 'co2_emission') |>
  select('sector_id', 'Industry', 'to_node', 'parameter', 'unit', '2025', '2030', '2040', '2050') |>
  rename('emission' = 'parameter') -> extra_data_co2_emission_filtered

aidres_2_0_perton |> clean_names() |>
    select(scenario_id:is_reference_route, direct_emission_tco2_t, captured_co2_tco2_t) |>
  pivot_longer(direct_emission_tco2_t: captured_co2_tco2_t, names_to = 'indicators', values_to = 'tco2_t') |>
  filter((horizon == 2030 & scenario_id == 1) | horizon == 2018) |>
  left_join(aidres_2_0_configurations |>select(configuration_id, mix_2018:mix_2050), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_configurations |>select(configuration_id, configuration), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_sectors, by =join_by('sector_id' == 'sector_id')) |>
  left_join(aidres_2_0_products, by = join_by('product_id' == 'product_id')) |>
  filter(
    (is_reference_route == 1 & scenario_id == 0 & product_id != 12 & product_id != 13) | 
    (mix_2040 != 0 & !grepl('mix', configuration) & product_id != 12 & product_id != 13 & is_reference_route != 1 & scenario_id != 0)|
        (configuration_id == 221) | (configuration_id == 241)) |>
  select(sector, product, configuration, indicators, tco2_t) |>
  rename(sector_id = sector) |>
  rename(product_id = product) |>
  distinct() |>
  pivot_wider(names_from = indicators, values_from = tco2_t) |> 
  rename('co2_capture' = captured_co2_tco2_t,
         'co2_emission' = direct_emission_tco2_t) |> 
  pivot_longer(co2_capture:co2_emission, names_to = 'emission', values_to = 'tco2_t') |> 
  rename('to_node' = product_id,
         'Industry' = configuration) |> 
  mutate(sector_id = tolower(sector_id)) |>
  select(sector_id, Industry, to_node, everything())  -> emission_perton_all

emission_perton_all_2025 <- emission_perton_all |> mutate(year = 2025)
emission_perton_all_2030 <- emission_perton_all |> mutate(year = 2030)
emission_perton_all_2040 <- emission_perton_all |> mutate(year = 2040)
emission_perton_all_2050 <- emission_perton_all |> mutate(year = 2050)

rbind(emission_perton_all_2025, emission_perton_all_2030, emission_perton_all_2040, emission_perton_all_2050) |> 
  pivot_wider(values_from = tco2_t, names_from = year) |> 
  mutate(unit = 'tco2_t') |> 
  select(sector_id:emission, unit, everything()) |>
  mutate(to_node = case_when(sector_id == 'refineries'~ 'HC',
                             .default = to_node)) |>
  pivot_longer(cols = `2025`:`2050`, names_to = 'year', values_to = 'value') |>
  mutate(value = case_when(sector_id == 'refineries' ~ round(value/11.92,3),
                           .default = value)) |>
  mutate(unit = case_when(sector_id == 'refineries' ~ 'tco2_mwh',
                           .default = 'tco2_t')) |>
  mutate(Industry = case_when(to_node == 'glass-container'~ paste0(Industry, '_gco'),
                              to_node == 'glass-fibre'~ paste0(Industry, '_gfi'),
                              to_node == 'glass-float'~ paste0(Industry, '_gfl'),
                              .default = Industry)) |>
pivot_wider(names_from = year, values_from = value) -> emission_perton_all

emission_co2_capture_perton_all <- emission_perton_all |> 
                                    filter(emission == 'co2_capture') |>
                                    bind_rows(extra_data_co2_capture_filtered) |>
                                    mutate(to_node = if_else(Industry %in% c("(H2)MeOH-DC", "(BM)MeOH", "(COEL)MeOH-MEA"), "HC-MeOH", to_node)) |>
                                    mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node))
emission_co2_capture_perton_all

emission_co2_emission_perton_all <- emission_perton_all |> 
                                    filter(emission == 'co2_emission') |>
                                    bind_rows(extra_data_co2_emission_filtered) |>
                                    mutate(to_node = if_else(Industry %in% c("(H2)MeOH-DC", "(BM)MeOH", "(COEL)MeOH-MEA"), "HC-MeOH", to_node)) |>
                                    mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node)) 
emission_co2_emission_perton_all

```

## Additional production data

Preprocess additional production data for CH, NO, and UK from 'Mopo_Data_Collection_CH_NO_UK.xlsx'

Important remarks: 
- We exclude the following products: 
  - 'urea' (to avoid double counting ammonia production) 
  - 'nitric acid' (to avoid double counting ammonia production) 
  - 'chlorine' (added later for all countries) 
- Preferred data from specific sources listed in Mopo_Data_Collection_CH_NO_UK.xlsx (latest year); if unavailable, fall back to PyPSA values. 
- For the products listed below, replace the PyPSA 'production index' with useful energy. Useful energy is obtained by applying product specific conversion factors from JRC‑IDEES ('input_data/processed_jrc_idees_data/useful_energy_per_production_index.csv'), generated by the 'jrc idees processing.py' script in the 'JRC idees processing python' folder (see section 'Add production, production route and CO₂ emission data for non‑Aidres sectors'): 
  - food, beverages and tobacco
  - leather and textile 
  - transport equipment 
  - machinery equipment 
  - wood and wood products 
  - other industrial sectors

```{r}
to_node_year_production_factor_relation_2018 <- data.frame(
  to_node = c('glass-container', 'cement', 'chemical-PE', 
             'chemical-PEA', 'chemical-olefins', 
             'HC', 'steel-secondary', 
             'steel-primary', 'fertiliser-ammonia-NH3', 'glass-float', 
             'glass-fibre', 'other-chemicals', 'pharmaceuticals',
             'food-beverages-tobacco', 'machinery-equipment', 'alumina',
             'aluminium-primary', 'aluminium-secondary', 'other-non-ferrous-metals',
             'ceramics-and-other-non-metalic-minerals', 'other-industrial-sectors',
             'paper', 'printing-and-media', 'pulp', 'leather-and-textile', 
             'transport-equipment', 'wood-and-wood-products', 'glass'),	
  production_factor_2018 = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
                             1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1))

to_node_year_production_factor_relation_2030 <- data.frame(
  to_node = c('glass-container', 'cement', 'chemical-PE', 
             'chemical-PEA', 'chemical-olefins', 
             'HC', 'steel-secondary', 
             'steel-primary', 'fertiliser-ammonia-NH3', 'glass-float', 
             'glass-fibre', 'other-chemicals', 'pharmaceuticals',
             'food-beverages-tobacco', 'machinery-equipment', 'alumina',
             'aluminium-primary', 'aluminium-secondary', 'other-non-ferrous-metals',
             'ceramics-and-other-non-metalic-minerals', 'other-industrial-sectors',
             'paper', 'printing-and-media', 'pulp', 'leather-and-textile', 
             'transport-equipment', 'wood-and-wood-products', 'glass'),	
  production_factor_2030 = c(1, 1, 1, 1, 1, 0.84, 1, 1, 1, 1, 1, 1, 1, 1, 
                             1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1))
  
  to_node_year_production_factor_relation_2050 <- data.frame(
  to_node = c('glass-container', 'cement', 'chemical-PE', 
             'chemical-PEA', 'chemical-olefins', 
             'HC', 'steel-secondary', 
             'steel-primary', 'fertiliser-ammonia-NH3', 'glass-float', 
             'glass-fibre', 'other-chemicals', 'pharmaceuticals',
             'food-beverages-tobacco', 'machinery-equipment', 'alumina',
             'aluminium-primary', 'aluminium-secondary', 'other-non-ferrous-metals',
             'ceramics-and-other-non-metalic-minerals', 'other-industrial-sectors',
             'paper', 'printing-and-media', 'pulp', 'leather-and-textile', 
             'transport-equipment', 'wood-and-wood-products', 'glass'),	
  production_factor_2050 = c(1, 1, 1, 1, 1, 0.29, 1, 1, 1, 1, 1, 1, 1, 1, 
                             1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1))
  
  
useful_energy_per_production <- read_delim(here("input_data/processed_jrc_idees_data", "useful_energy_per_production_index.csv"), locale = locale(decimal_mark = ".")) |>
  mutate(
    sector_id = case_when(
      grepl("FBT", sector) ~ "food-beverages-and-tobacco",
      grepl("TEL", sector) ~ "aluminium-secondary-production-reference",
      grepl("TRE", sector) ~ "transport-equipment",
      grepl("MAE", sector) ~ "machinery-equipment",
      grepl("WWP", sector) ~ "wood-and-wood-products",
      grepl("OIS", sector) ~ "other-industrial-sectors")
    ) |> select(sector_id, useful_energy_per_capacity)
  
  
extra_data_production_processed <- extra_data_production |>
  group_by(commodity) |>
  mutate(has_latest = any(latest_year == "latest")) |>
  ungroup() |>
  filter(
    (latest_year == "latest") |
    (!has_latest & latest_year == "pypsa")) |>
  filter(
    (!commodity == 'urea') &
      (!commodity == 'nitric acid') &
      (!commodity == 'chlorine') &
      (!commodity == 'methanol')) |>
  mutate(
    sector_id = case_when(
      grepl("aluminium-primary", commodity) ~ "non-ferrous-metals",
      grepl("aluminium-secondary", commodity) ~ "non-ferrous-metals",
      grepl("other chemicals", commodity) ~ "chemical",
      grepl("pharmaceuticals", commodity) ~ "chemical",     
      grepl("ceramics and other NMM", commodity) ~ "ceramics-and-other-non-metallic-mineral-products-excluding-cement-and-glass",
      grepl("all glass", commodity) ~ "glass",      
      grepl("pulp", commodity) ~ "pulp-and-paper",
      grepl("paper and paperboard", commodity) ~ "pulp-and-paper",
      grepl("printing and media reproduction", commodity) ~ "pulp-and-paper",  
      grepl("food, beverages and tobacco", commodity) ~ "food-beverages-and-tobacco",
      grepl("alumina", commodity) ~ "non-ferrous-metals",   
      grepl("other non-ferrous metals", commodity) ~ "non-ferrous-metals",
      grepl("transport equipment", commodity) ~ "transport-equipment", 
      grepl("machinery equipment", commodity) ~ "machinery-equipment",
      grepl("textiles and leather", commodity) ~ "textiles-and-leather",
      grepl("wood and wood products", commodity) ~ "wood-and-wood-products",  
      grepl("other industrial sectors", commodity) ~ "other-industrial-sectors",
      grepl("cement", commodity) ~ "cement",
      grepl("ammonia", commodity) ~ "fertiliser", 
      grepl("steel-primary", commodity) ~ "steel",  
      grepl("steel-secondary", commodity) ~ "steel",
      grepl("glass-flat", commodity) ~ "glass",
      grepl("glass-fibre", commodity) ~ "glass", 
      grepl("glass-container", commodity) ~ "glass",
      grepl("olefins", commodity) ~ "chemical",  
      grepl("light liquid fuel", commodity) ~ "refineries",
      grepl("methanol", commodity) ~ "refineries"
    )
  ) |>
  mutate(
    to_node = case_when(
      grepl("aluminium-primary", commodity) ~ "aluminium-primary",
      grepl("aluminium-secondary", commodity) ~ "aluminium-secondary",
      grepl("other chemicals", commodity) ~ "other-chemicals",
      grepl("pharmaceuticals", commodity) ~ "pharmaceuticals",     
      grepl("ceramics and other NMM", commodity) ~ "ceramics-and-other-non-metalic-minerals",
      grepl("all glass", commodity) ~ "glass",      
      grepl("pulp", commodity) ~ "pulp",
      grepl("paper and paperboard", commodity) ~ "paper",
      grepl("printing and media reproduction", commodity) ~ "printing-and-media",  
      grepl("food, beverages and tobacco", commodity) ~ "food-beverages-tobacco",
      grepl("alumina", commodity) ~ "alumina",   
      grepl("other non-ferrous metals", commodity) ~ "other-non-ferrous-metals",
      grepl("transport equipment", commodity) ~ "transport-equipment", 
      grepl("machinery equipment", commodity) ~ "machinery-equipment",
      grepl("textiles and leather", commodity) ~ "leather-and-textile",
      grepl("wood and wood products", commodity) ~ "wood-and-wood-products",  
      grepl("other industrial sectors", commodity) ~ "other-industrial-sectors",
      grepl("cement", commodity) ~ "cement",
      grepl("ammonia", commodity) ~ "fertiliser-ammonia-NH3", 
      grepl("steel-primary", commodity) ~ "steel-primary",  
      grepl("steel-secondary", commodity) ~ "steel-secondary",
      grepl("glass-flat", commodity) ~ "glass-float",
      grepl("glass-fibre", commodity) ~ "glass-fibre", 
      grepl("glass-container", commodity) ~ "glass-container",
      grepl("olefins", commodity) ~ "chemical-olefins",  
      grepl("light liquid fuel", commodity) ~ "HC",
      grepl("methanol", commodity) ~ "HC-MeOH"
    )
  ) |>
  mutate(
    Industry = case_when(
      grepl("aluminium-primary", commodity) ~ "aluminium-primary-production-reference",
      grepl("aluminium-secondary", commodity) ~ "aluminium-secondary-production-reference",
      grepl("other chemicals", commodity) ~ "other-chemicals-production-reference",
      grepl("pharmaceuticals", commodity) ~ "pharmaceuticals-production-reference",     
      grepl("ceramics and other NMM", commodity) ~ "ceramics-and-other-non-metalic-minerals-production-reference",
      grepl("all glass", commodity) ~ "(NG)_gfl",      # check this
      grepl("pulp", commodity) ~ "pulp-production-reference",
      grepl("paper and paperboard", commodity) ~ "paper-production-reference",
      grepl("printing and media reproduction", commodity) ~ "printing-and-media-production-reference",  
      grepl("food, beverages and tobacco", commodity) ~ "food-beverages-tobacco-production-reference",
      grepl("alumina", commodity) ~ "alumina-production-reference",   
      grepl("other non-ferrous metals", commodity) ~ "other-non-ferrous-metals-production-reference",
      grepl("transport equipment", commodity) ~ "transport-equipment-production-reference", 
      grepl("machinery equipment", commodity) ~ "machinery-equipment-production-reference",
      grepl("textiles and leather", commodity) ~ "leather-and-textile-production-reference",
      grepl("wood and wood products", commodity) ~ "wood-and-wood-products_production-reference",  
      grepl("other industrial sectors", commodity) ~ "other-industrial-sectors_production-reference",
      grepl("cement", commodity) ~ "EU-mix-2018",
      grepl("ammonia", commodity) ~ "(NG)NH3", 
      grepl("steel-primary", commodity) ~ "BF-BOF",  
      grepl("steel-secondary", commodity) ~ "Scraps_EAF",
      grepl("glass-flat", commodity) ~ "(NG)_gfl",
      grepl("glass-fibre", commodity) ~ "(NG)_gfi", 
      grepl("glass-container", commodity) ~ "(NG)_gco",
      grepl("olefins", commodity) ~ "(LN)O",  
      grepl("light liquid fuel", commodity) ~ "REF-SMR",
      grepl("methanol", commodity) ~ "(BM)MeOH"   #Correct?
    )
  ) |>
  left_join(to_node_year_production_factor_relation_2018, by = c("to_node")) |>
  mutate(`2018o` = round(value_conv*production_factor_2018)) |>
  left_join(to_node_year_production_factor_relation_2030, by = c("to_node")) |>
  mutate(`2030o` = round(value_conv*production_factor_2030)) |>
  left_join(to_node_year_production_factor_relation_2050, by = c("to_node")) |>
  mutate(`2050o` = round(value_conv*production_factor_2050)) |>
  left_join(useful_energy_per_production, by = c("sector_id")) |>
  mutate(`2018` = `2018o` * if_else(!is.na(useful_energy_per_capacity), useful_energy_per_capacity/0.0036, 1)) |>
  mutate(`2030` = `2030o` * if_else(!is.na(useful_energy_per_capacity), useful_energy_per_capacity/0.0036, 1)) |>
  mutate(`2050` = `2050o` * if_else(!is.na(useful_energy_per_capacity), useful_energy_per_capacity/0.0036, 1)) |>
  mutate(unit = if_else(!is.na(useful_energy_per_capacity), "mwh_yr", unit))

extra_data_production_processed_2018 <- extra_data_production_processed |>
  select(c(country_code, sector_id, to_node, Industry, unit, `2018`))

extra_data_production_processed_2030_2050 <- extra_data_production_processed |>
  select(c(country_code, sector_id, to_node, unit, `2030`, `2050`))

extra_data_production_processed
```

## Production

### Production volume at nuts0

Aggregated product flow information at national level (nuts0). 
Important remarks:
- For 2018, production routes and product flow are mapped. However, for future years only product flow is mentioned
- The AIDRES 2.0 database contains both the INEOS ethane cracker and the TOA cracker, but they, respectively, open in 2026 and close in 2027. Therefore we do the following:
  - INEOS ethane cracker (BE211) operational in 2026: 1909 kt/y * 0.84 --> subtract from 2018
  - TOA cracker (BE211) closure in 2027: 2273 kt/y * 0.84 --> subtract from 2030 and 2050
- We add the additional production data for UK, CH and NO

```{r}
aidres_2_0_results |> clean_names() |>
  filter(scenario_id %in% c(0, 1, 5)) |> 
  left_join(aidres_2_0_configurations |>select(configuration_id, mix_2018:mix_2050), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_configurations |>select(configuration_id, configuration), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_sectors, by = join_by('sector_id' == 'sector_id')) |>
  left_join(aidres_2_0_products, by = join_by('product_id' == 'product_id')) |>
  filter((is_reference_route == 1 & product_id != 12 & product_id != 13) | (product_id == 0 & (configuration == 'EU-mix-2030' | configuration == 'EU-mix-2050'))) |>
  select(sector, product, configuration, product_flow_kt_y, horizon, nuts3, is_reference_route, conversion_factor) |>
  rename(sector_id = sector) |>
  rename(product_id = product) |>
  distinct() |> 
  group_by(nuts3) |> 
  distinct(product_id, horizon, .keep_all = TRUE) |> 
  rename('production_route_name' = configuration) |> 
  rename('production_factor' = conversion_factor) |> 
  rename('year' = horizon) |> 
  rename('is_ref_route' = is_reference_route) |> 
  arrange(nuts3, sector_id, product_id, production_route_name, .by_group = TRUE) |> 
  separate_wider_position(nuts3, c(country_code = 2, 1, nuts_id = 2)) |>
  mutate(sector_id = tolower(sector_id)) |>
  rename('Industry' = production_route_name,
         'to_node' = product_id)  -> aidres_production_country_temp

aidres_production_country_temp |> 
  filter(year == 2018) |> 
  group_by(country_code, sector_id, to_node, Industry, year) |> 
  summarise(production = sum(product_flow_kt_y), .groups = 'drop') |> 
  mutate(unit = 'kt_y') |> 
  select(country_code:year, unit, everything()) |>
  mutate(production = case_when(
      country_code == "BE" & to_node == "chemical-olefins" ~ production - 1909,
      TRUE ~ production)) -> aidres_production_country_2018year

aidres_production_country_temp |> 
  filter(year != 2018) |> 
  group_by(country_code, sector_id, to_node, year) |> 
  summarise(production = sum(product_flow_kt_y), .groups = 'drop') |>  
  mutate(unit = 'kt_y') |> 
  select(country_code:year, unit, everything()) |>
  mutate(production = case_when(
      country_code == "BE" & to_node == "chemical-olefins" ~ production - 2273,
      TRUE ~ production)) ->  aidres_production_country_allyear



# Conversion from kt LLF to MWh LLF (approximately 42.87 MJ/kg = 11.92 MWh/ton)
# Source: https://www.engineeringtoolbox.com/fossil-fuels-energy-content-d_1298.html

aidres_production_country_2018year |> 
  mutate(year = as.double(year)) |>
  mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node)) |>
  filter(production != 0) |> 
  pivot_wider(names_from = year, values_from = production) |>
  bind_rows(extra_data_production_processed_2018) |>
  mutate(to_node = case_when(sector_id == 'refineries'~ 'HC',
                             .default = to_node)) |>
  pivot_longer(cols = `2018`, names_to = 'year', values_to = 'value') |>
  mutate(value = case_when(sector_id == 'refineries' ~ round(value*11.92*1000,3),
                            .default = value)) |>
  mutate(unit = case_when(sector_id == 'refineries' ~ 'mwh_yr',
                            .default = unit)) |>
  mutate(Industry = case_when(to_node == 'glass-container'~ paste0(Industry, '_gco'),
                              to_node == 'glass-fibre'~ paste0(Industry, '_gfi'),
                              to_node == 'glass-float'~ paste0(Industry, '_gfl'),
                              .default = Industry)) |>
 pivot_wider(names_from = year, values_from = value) -> prod_vol_cap_2018year
prod_vol_cap_2018year

aidres_production_country_allyear <- aidres_production_country_allyear |>
  mutate(year = as.double(year)) |>
  mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node)) |>
  filter(production != 0) |> 
  pivot_wider(names_from = year, values_from = production) |>
  bind_rows(extra_data_production_processed_2030_2050) |>
  mutate(to_node = case_when(sector_id == 'refineries'~ 'HC',
                             .default = to_node)) |>
  pivot_longer(cols = `2030`:`2050`, names_to = 'year', values_to = 'value') |>
  mutate(value = case_when(sector_id == 'refineries' ~ round(value*11.92*1000,3),
                           .default = value)) |>
  mutate(unit = case_when(sector_id == 'refineries' ~ 'mwh_yr',
                          .default = unit)) |>
  pivot_wider(names_from = year, values_from = value)->prod_vol_cap_allyear
prod_vol_cap_allyear
```

### Production volumes at nuts3

Aggregated product flow information at nuts3 level. 
Important remarks:
- For 2018, production routes and product flow are mapped. However, for future years only product flow is mentioned
- Data for Switzerland, UK and Norway is not available on nuts3 level
- The AIDRES 2.0 database contains both the INEOS ethane cracker and the TOA cracker, but they, respectively, open in 2026 and close in 2027. Therefore we do the following:
  - INEOS ethane cracker (BE211) operational in 2026: 1909 kt/y * 0.84 --> subtract from 2018
  - TOA cracker (BE211) closure in 2027: 2273 kt/y * 0.84 --> subtract from 2030 and 2050
  
```{r}
aidres_2_0_results |> clean_names() |>
  filter(scenario_id %in% c(0, 1, 5)) |> 
  left_join(aidres_2_0_configurations |>
              select(configuration_id, mix_2018:mix_2050), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_configurations |>select(configuration_id, configuration), by =join_by('configuration_id' == 'configuration_id')) |>
  left_join(aidres_2_0_sectors, by = join_by('sector_id' == 'sector_id')) |>
  left_join(aidres_2_0_products, by = join_by('product_id' == 'product_id')) |>
  filter((is_reference_route == 1 & product_id != 12 & product_id != 13) | (product_id == 0 & (configuration == 'EU-mix-2030' | configuration == 'EU-mix-2050'))) |>
  select(sector, product, configuration, product_flow_kt_y, horizon, nuts3, is_reference_route, conversion_factor) |>
  rename(sector_id = sector) |>
  rename(product_id = product) |>
  distinct() |> 
  group_by(nuts3) |> 
  distinct(product_id, horizon, .keep_all = TRUE) |> 
  mutate(prod_cap_kt_y = product_flow_kt_y / conversion_factor) |> 
  rename('production_route_name' = configuration) |> 
  rename('production_factor' = conversion_factor) |> 
  rename('year' = horizon) |> 
  rename('is_ref_route' = is_reference_route) |> 
  arrange(nuts3, sector_id, product_id, production_route_name, .by_group = TRUE) |> 
  separate_wider_position(nuts3, c(country_code = 2, 1, nuts_id =2), cols_remove = FALSE) |> 
  mutate(sector_id = tolower(sector_id)) |>
  select(-nuts_id) -> aidres_production_country_temp_nuts3

aidres_production_country_temp_nuts3 |> 
  filter(year == 2018) |> 
  group_by(country_code, nuts3, sector_id, product_id, production_route_name, year) |> 
  summarise(production = sum(product_flow_kt_y),
            production_cap = sum(prod_cap_kt_y), .groups = 'drop') |> 
  mutate(unit = 'kt_y') |> 
  rename('Industry' = production_route_name,
         'to_node' = product_id) |> 
  select(country_code:year, unit, everything()) |>
  mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node)) |> 
  select(-production_cap) |> 
  mutate(production = case_when(
    nuts3 == "BE211" & to_node == "chemical-olefins" ~ production - 1909,
    TRUE ~ production)) |>
  pivot_wider(names_from = year, values_from = production) |>
  mutate(to_node = case_when(sector_id == 'refineries'~ 'HC',
                             .default = to_node)) |>
   pivot_longer(cols = `2018`, names_to = 'year', values_to = 'value') |>
   mutate(value = case_when(sector_id == 'refineries' ~ round(value*11.92*1000,3),
                            .default = value)) |>
   mutate(unit = case_when(sector_id == 'refineries' ~ 'mwh_yr',
                            .default = 'kt_yr')) |>
  mutate(Industry = case_when(to_node == 'glass-container'~ paste0(Industry, '_gco'),
                              to_node == 'glass-fibre'~ paste0(Industry, '_gfi'),
                              to_node == 'glass-float'~ paste0(Industry, '_gfl'),
                              .default = Industry)) |>
 pivot_wider(names_from = year, values_from = value) -> prod_vol_cap_2018year_nuts3
prod_vol_cap_2018year_nuts3

aidres_production_country_temp_nuts3 |> 
  filter(year != 2018) |> 
  group_by(country_code, nuts3, sector_id, product_id, year) |> 
  summarise(production = sum(product_flow_kt_y),
            production_cap = sum(prod_cap_kt_y), .groups = 'drop') |>  
  mutate(unit = 'kt_y') |> 
  rename('to_node' = product_id) |> 
  select(country_code:year, unit, everything()) |>
  mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node)) |> 
  select(-production_cap) |> 
  mutate(production = case_when(
    nuts3 == "BE211" & to_node == "chemical-olefins" ~ production - 2273,
    TRUE ~ production)) |>
  pivot_wider(names_from = year, values_from = production) |>
  mutate(to_node = case_when(sector_id == 'refineries'~ 'HC',
                             .default = to_node)) |>
   pivot_longer(cols = `2030`:`2050`, names_to = 'year', values_to = 'value') |>
   mutate(value = case_when(sector_id == 'refineries' ~ round(value*11.92*1000,3),
                            .default = value)) |>
   mutate(unit = case_when(sector_id == 'refineries' ~ 'mwh_yr',
                            .default = 'kt_yr')) |>
 pivot_wider(names_from = year, values_from = value)->prod_vol_cap_allyear_nuts3
prod_vol_cap_allyear_nuts3
```

## Life

AIDRES assumes a generic 40 year lifetime for technologies.

```{r}
extra_data_processes |> 
  filter(parameter == 'life') |>
  select('sector_id', 'Industry', 'to_node', 'unit', '2030') |>
  rename('life' = '2030') -> extra_data_life_filtered

costs_capex_perton_all |> 
  select(-c(`2025`: `2050`, costs)) |> 
  mutate(unit = 'yr',
         life = 40) |>
  filter(!Industry %in% extra_data_life_filtered$Industry)|>
  bind_rows(extra_data_life_filtered) |>
  mutate(to_node = if_else(Industry %in% c("(H2)MeOH-DC", "(BM)MeOH", "(COEL)MeOH-MEA"), "HC-MeOH", to_node)) |>
  mutate(to_node = if_else(to_node %in% c("fertiliser-ammonia"), "fertiliser-ammonia-NH3", to_node)) -> life_prodroute_all

life_prodroute_all
  
```

## Get chlorine production data and add to technology catalogue

Get chlorine production data from the Eurochlor excel (/input_data/eurochlor_data/chlorine_data_2018.xlsx) and add to the technology catalogue. The site coordinates (/input_data/eurochlor_data/chlorine_sites_coordinates.csv) are used to determine the nuts3 level.

Important remark:
A utilization factor of 0.688 is used for chlorine (= utilization factor of first half 2025, https://www.eurochlor.org/news/november-2025-chlorine-production/))

```{r}
country_codes <- read_xlsx(here('input_data', 'europe_country_codes', 'europe_country_code.xlsx'), sheet = 1)

country_codes_extended <- rbind(
  country_codes,
  data.frame(country = c("Norway", "UK", "Switzerland"), country_iso_code = c("NO", "UK", "Ch"), stringsAsFactors = FALSE)
)

chlorine_data_2018 <- read_xlsx(here('input_data', 'eurochlor_data', 'chlorine_data_2018.xlsx'), sheet = 'Sheet2', range = 'A1:H67') |> 
  clean_names() |> 
  left_join(country_codes_extended, by = join_by('country' == 'country')) |> 
  select(country_iso_code, country, company, site, everything()) |> 
  filter(!is.na(country_iso_code)) |> 
  select(-thousand_tonnes) |> 
  pivot_longer(cols = murcury:other, names_to = 'production_routes', values_to = 'kt') |> 
  mutate(kt = replace_na(kt, 0)) |> 
  group_by(country_iso_code , country, company, site) |> 
  reframe(kt = sum(cbind(kt)))

chlorine_coordinates <- read_delim(here('input_data', 'eurochlor_data', "chlorine_sites_coordinates.csv"), locale = locale(decimal_mark = "."), show_col_types = FALSE) |> clean_names()

chlorine_data_2018_with_coordinates <- left_join(chlorine_data_2018, chlorine_coordinates, by = join_by(country == country, site == site, company == company))

chlorine_data_2018_with_coordinates_sf <- st_as_sf(chlorine_data_2018_with_coordinates, coords = c("longitude", "latitude"), crs = 4326)

# Download NUTS layers
nuts3 <- gisco_get_nuts(nuts_level = 3, year = 2016)
nuts0 <- gisco_get_nuts(nuts_level = 0, year = 2016)

# Add nuts3
chlorine_data_2018_with_coordinates_sf <- chlorine_data_2018_with_coordinates_sf %>%
  st_join(nuts3 %>% select(NUTS_ID), left = TRUE) %>%
  rename(nuts3 = NUTS_ID) %>%
  st_join(nuts0 %>% select(NUTS_ID), left = TRUE) %>%
  rename(nuts0 = NUTS_ID)

# Fallback for missing nuts3
missing_idx <- which(is.na(chlorine_data_2018_with_coordinates_sf$nuts3))

if (length(missing_idx) > 0) {
  nearest_idx <- st_nearest_feature(
    chlorine_data_2018_with_coordinates_sf[missing_idx, ],
    nuts3
  )
  chlorine_data_2018_with_coordinates_sf$nuts3[missing_idx] <- nuts3$NUTS_ID[nearest_idx]
}

chlorine_data <- chlorine_data_2018_with_coordinates_sf

chlorine_data$`2018` <- chlorine_data$kt*0.688
chlorine_data$`2030` <- chlorine_data$kt*0.688
chlorine_data$`2050` <- chlorine_data$kt*0.688

chlorine_data$unit <- "kt_yr"
chlorine_data$to_node <- "chemical-chlorine"
chlorine_data$sector_id <- "chemical"
chlorine_data$country_code <- chlorine_data$country_iso_code
chlorine_data$Industry <- "Diaphragm"

chlorine_production_2018_nuts3 <- chlorine_data %>% 
  select(country_code, nuts3, sector_id, to_node, Industry, unit, `2018`) %>%
  sf::st_drop_geometry()
chlorine_production_2018_nuts0 <- chlorine_data %>% 
  select(country_code, sector_id, to_node, Industry, unit, `2018`) %>%
  sf::st_drop_geometry() %>%
  group_by(country_code, sector_id, to_node, Industry, unit) %>%
  summarise(`2018` = sum(`2018`, na.rm = TRUE), .groups = "drop")

chlorine_production_2030_2050_nuts3 <- chlorine_data %>% 
  select(country_code, nuts3, sector_id, to_node, unit, `2030`, `2050`) %>%
  sf::st_drop_geometry()
chlorine_production_2030_2050_nuts0 <- chlorine_data %>% 
  select(country_code, sector_id, to_node, unit, `2030`, `2050`) %>%
  sf::st_drop_geometry() %>%
  group_by(country_code, sector_id, to_node, unit) %>%
  summarise(
    `2030` = sum(`2030`, na.rm = TRUE),
    `2050` = sum(`2050`, na.rm = TRUE),
    .groups = "drop"
  )

prod_vol_cap_2018year_nuts3 <- bind_rows(prod_vol_cap_2018year_nuts3, chlorine_production_2018_nuts3)
prod_vol_cap_allyear_nuts3 <- bind_rows(prod_vol_cap_allyear_nuts3, chlorine_production_2030_2050_nuts3)
prod_vol_cap_2018year <- bind_rows(prod_vol_cap_2018year, chlorine_production_2018_nuts0)
prod_vol_cap_allyear <- bind_rows(prod_vol_cap_allyear, chlorine_production_2030_2050_nuts0)
```

## Get chlorine production route and add to technology catalogue

Retrieve the data for the chlorine production route from '/input_data/eurochlor_data/chlorine_route.xlsx' and incorporate it into the technology catalogue. For the cost parameters and technology lifetime, the values from our TIMES-Belgium model are applied. All remaining parameters are sourced from the document “EPOC – Chemical Sector Decarbonization” available at: https://www.epocbelgium.be/sites/epoc/files/Chlorine_FactSheet_TaliehRajabloo.pdf.

Important remark:
Although several chlorine production processes exist, the diaphragm cell process is by far the most widely used. Therefore, the diaphragm-based production route has been added to the technology catalogue.

```{r}

chlorine_process <- read_xlsx(here('input_data', 'eurochlor_data', 'chlorine_route.xlsx'), sheet = 'Sheet1', range = 'B1:J3')[-1, ] 
chlorine_process_unpivot <- chlorine_process%>%
  pivot_longer(
    cols = c(CAPEX, OPEX, `CO2 direct emissions`, `CO2 capture`, electricity, natural_gas, lifetime, hydrogen_by_product),
    names_to = "variable",
    values_to = "value"
  ) %>%
mutate(
    value = as.numeric(value),      # Convert all values to numeric
    value = round(value, 2)         # Round to 2 decimals
  ) %>%
mutate(variable = case_when(
    variable == "electricity" ~ "elec",
    variable == "natural_gas" ~ "CH4",
    variable == "CO2 capture" ~ "co2_capture",
    variable == "CO2 direct emissions" ~ "co2_emission",
    variable == "CAPEX" ~ "capex",
    variable == "OPEX" ~ "fom",
    TRUE ~ variable
  ))

chlorine_process_unpivot$to_node <- "chemical-chlorine"
chlorine_process_unpivot$sector_id <- "chemical"
chlorine_process_unpivot$Industry <- "Diaphragm"
chlorine_process_unpivot$`2025` <- chlorine_process_unpivot$value
chlorine_process_unpivot$`2030` <- chlorine_process_unpivot$value
chlorine_process_unpivot$`2040` <- chlorine_process_unpivot$value
chlorine_process_unpivot$`2050` <- chlorine_process_unpivot$value

chlorine_ind_process_routes_sec <- chlorine_process_unpivot %>% select(sector_id, to_node, Industry, variable, `2025`, `2030`,  `2040`, `2050`) %>%
  filter(variable %in% c("elec", "CH4")) %>%
  rename(from_node = variable)
chlorine_ind_process_routes_sec$unit = 'mwh_t'

chlorine_ind_process_route_life <- chlorine_process_unpivot %>% select(sector_id, to_node, Industry, value, variable) %>%
  filter(variable %in% c("lifetime")) %>%
  select(-variable) %>%
  rename(life = value)
chlorine_ind_process_route_life$unit = 'yr'

chlorine_ind_process_routes_co2_capture <- chlorine_process_unpivot %>% select(sector_id, to_node, Industry, variable, `2025`, `2030`,  `2040`, `2050`) %>%
  filter(variable %in% c("co2_capture")) %>%
  rename(emission = variable)
chlorine_ind_process_routes_co2_capture$unit = 'tCO2_t'

chlorine_ind_process_routes_co2_emission <- chlorine_process_unpivot %>% select(sector_id, to_node, Industry, variable, `2025`, `2030`,  `2040`, `2050`) %>%
  filter(variable %in% c("co2_emission")) %>%
  rename(emission = variable)
chlorine_ind_process_routes_co2_emission$unit = 'tCO2_t'

chlorine_ind_process_routes_capex <- chlorine_process_unpivot %>% select(sector_id, to_node, Industry, variable, `2025`, `2030`,  `2040`, `2050`) %>%
  filter(variable %in% c("capex")) %>%
  rename(costs = variable)
chlorine_ind_process_routes_capex$unit = 'eur-yr_t'

chlorine_ind_process_routes_fom <- chlorine_process_unpivot %>% select(sector_id, to_node, Industry, variable, `2025`, `2030`,  `2040`, `2050`) %>%
  filter(variable %in% c("fom")) %>%
  rename(costs = variable)
chlorine_ind_process_routes_fom$unit = 'eur_t'

sec_perton_all <- bind_rows(sec_perton_all,chlorine_ind_process_routes_sec)
life_prodroute_all <- bind_rows(life_prodroute_all,chlorine_ind_process_route_life) 
emission_co2_capture_perton_all <- bind_rows(emission_co2_capture_perton_all,chlorine_ind_process_routes_co2_capture)
emission_co2_emission_perton_all <- bind_rows(emission_co2_emission_perton_all,chlorine_ind_process_routes_co2_emission)
costs_capex_perton_all <- bind_rows(costs_capex_perton_all,chlorine_ind_process_routes_capex)
costs_fom_perton_all <- bind_rows(costs_fom_perton_all,chlorine_ind_process_routes_fom)
```

# Add production, production route and CO2 emission data for non-Aidres sectors

The production, production route and CO2 emission data for the following products is extracted from JRC idees: 
- food, beverages and tobacco
- alumina
- primary aluminium
- secondary aluminium
- other non-ferrous metals
- ceramics and other non-metallic minerals
- paper
- printing and media
- pulp
- leather and textile
- transport equipment
- machinery equipment
- wood and wood products
- other_industrial_sectors
- other chemicals
- pharmaceuticals

For the following products, useful energy (in MWh) is used as production unit instead of the 'production index' used in JRC-IDEES:
- food, beverages and tobacco
- leather and textile
- transport equipment
- machinery equipment
- wood and wood products
- other_industrial_sectors

The JRC idees data extraction and pre-processing is done by the 'jrc idees processing.py' script in the 'JRC idees processing python' folder:
  - The production capacity data is extracted from the main tabs of the JRC idees files (e.g. NMM, PPA ...)
  - The production route energy data is extracted from the '_fec' tabs of the JRC idees files (e.g. NMM_fec, PPA_fec ...)
  - The production route useful energy data is extracted from the '_ued' tabs of the JRC idees files (e.g. NMM_fec, PPA_fec ...)
  - The CO2 emission data is extracted from the '_emi' tabs of the JRC idees files (e.g. NMM_fec, PPA_fec ...)
  
The following parameters are calculated:
 - average (over all countries) of 'energy use per production unit' (for every energy carrier) per product
 - average (over all countries) of 'emissions per production unit' per product
 - production capacity data

For the original production routes, the following mapping is used to map the energy carriers in JRC-idees to the energy carriers used in the energy balance and the technology catalogue ('JRC-idees carrier': 'energy balance carrier'-'technology catalogue carrier'):
  - 'Solar and geothermal': 'heat'-'elec'
  - 'Electricity': 'electricity'-'elec'
  - 'LPG': 'oil_petro_products'-'HC'
  - 'Diesel oil and liquid biofuels': 'oil_petro_products'-'HC'
  - 'Diesel oil': 'oil_petro_products'-'HC'
  - 'Naphtha': 'oil_petro_products'-'HC'
  - 'Natural gas and biogas': 'natural_gas'-'CH4'
  - 'Natural gas': 'natural_gas'-'CH4'
  - 'Solids': 'solid_fossil_fuels'-'coal'
  - 'Refinery gas': 'oil_petro_products'-'HC'
  - 'Fuel oil': 'oil_petro_products'-'HC'
  - 'Other liquids': 'oil_petro_products'-'HC'
  - 'Derived gases': 'solid_fossil_fuels',
  - 'Biomass and waste': 'renew_bio'-'bio'
  - 'Distributed steam': 'steam'-'elec' or 'CH4'
  - 'Ambient heat': 'heat'-'elec' or 'CH4'
  - 'Coke': 'solid_fossil_fuels'-'coal'
  Remark: both 'steam' and 'heat' are converted to either electricity or natural gas, depending on the temperature needed.

For every product, an alternative production route is constructed. To replace an energy carrier by an alternative energy carrier, we always multiply the energy use by the efficiency of the original energy carrier and divide by the energy efficiency of the alternative energy carrier. E.g. part of 'Food: Oven (direct heat)' is done electrically in JRC idees, but another part uses Diesel oil and liquid biofuels, Natural gas and biogas... In this case all 'Food: Oven (direct heat)' will be done electrically, where the existing energy efficiencies in JRC idees are used for the conversion. In case of low temperature heat, we use the efficiency of an industrial heat pump to provide the heat with an efficiency of 285% (= average of Danish technology catalogue: https://ens.dk/en/analyses-and-statistics/technology-data-industrial-process-heat).

The folling mapping is used to map JRC-IDEES processes to an alternative energy carrier for the alternative production route:
  - natural gas:
    - Mach. Eq.: Foundries
    - Trans. Eq.: Foundries
    - Chemicals: High-enthalpy heat processing
    - Chemicals: Furnaces
    - Alumina production: High-enthalpy heat
  - electricity provided by a heat pump:
    - Low-enthalpy heat
    - Food: Specific process heat
    - Food: Drying
    - Food: Process cooling and refrigeration
    - Paper: Stock preparation
    - Paper: Paper machine
    - Paper: Product finishing
    - Textiles: Pretreatment with steam
    - Textiles: Wet processing with steam
    - Textiles: Drying
    - Ceramics: Product finishing
    - Chemicals: Process cooling
    - Trans. Eq.: Steam processing
    - Mach. Eq.: Steam processing
    - Wood: Drying
    - Wood: Specific processes with steam
    - Other Industrial sectors: Drying
    - Other Industrial sectors: Process Cooling
  - electricity:
    - Alumina production: Refining
    - Aluminium electrolysis (smelting)
    - Aluminium processing  (metallurgy e.g. cast house, reheating)
    - Aluminium finishing
    - Secondary aluminium (incl. pre-treatment, remelting)
    - Metal processing  (metallurgy e.g. cast house, reheating)
    - Other Metals: production
    - Metal finishing
    - Food: Oven (direct heat)
    - Food: Steam processing
    - Food: Electric machinery
    - Pulp: Wood preparation, grinding
    - Pulp: Pulping
    - Pulp: Cleaning
    - Printing and publishing
    - Textiles: Electric general machinery
    - Textiles: Finishing Electric
    - Ceramics: Mixing of raw material
    - Ceramics: Drying and sintering of raw material
    - Ceramics: Primary production process
    - Steel: Furnaces, refining and rolling
    - Steel: Product finishing
    - Trans. Eq.: Connection techniques
    - Trans. Eq.: Heat treatment
    - Trans. Eq.: General machinery
    - Trans. Eq.: Product finishing
    - Mach. Eq.: Connection techniques
    - Mach. Eq.: Heat treatment
    - Mach. Eq.: General machinery
    - Mach. Eq.: Product finishing
    - Wood: Electric mechanical processes
    - Wood: Finishing Electric
    - Other Industrial sectors: Steam processing
    - Other Industrial sectors: Process heating
    - Other Industrial sectors: Diesel motors (incl. biofuels)
    - Other Industrial sectors: Electric machinery
    
The CAPEX and OPEX for the alternative production routes are calculated by the 'jrc idees processing.py' script in the 'JRC idees processing python' folder. The CAPEX and OPEX are extracted from the Danish Technology Catalogue (https://ens.dk/en/analyses-and-statistics/technology-data-industrial-process-heat) for the following technologies:
- High-temperature heat pumps up to 150 °C										
- Electric boiler, 10 kV, steam, 1-12 bar										
- Boiler, gas and oil										



```{r}
proces_energy_new <- read_delim(here("input_data/processed_jrc_idees_data", "proces_energy_new.csv"), locale = locale(decimal_mark = "."))
proces_energy_new <- proces_energy_new %>% select("sector_id", "to_node", "unit", "Industry", "from_node",
                             `2025`, `2030`, `2040`, `2050`)

proces_energy_original <- read_delim(here("input_data/processed_jrc_idees_data", "proces_energy_original.csv"), locale = locale(decimal_mark = "."))
proces_energy_original <- proces_energy_original %>% select("sector_id", "to_node", "unit", "Industry", "from_node",
                             `2025`, `2030`, `2040`, `2050`)

production_new <- read_delim(here("input_data/processed_jrc_idees_data", "production_new.csv"), locale = locale(decimal_mark = "."))
production_new <- production_new %>% select("country_code", "sector_id", "to_node", "unit", `2030`, `2050`)

production_original <- read_delim(here("input_data/processed_jrc_idees_data", "production_original.csv"), locale = locale(decimal_mark = "."))
production_original <- production_original %>% select("country_code", "sector_id", "to_node", "Industry", "unit", `2018`)

CO2_emissions_original <- read_delim(here("input_data/processed_jrc_idees_data", "CO2_emissions_original.csv"), locale = locale(decimal_mark = "."))
CO2_emissions_original <- CO2_emissions_original %>% select("sector_id", "Industry", "to_node", "emission", "unit", `2025`, `2030`, `2040`, `2050`)

CO2_emissions_new <- read_delim(here("input_data/processed_jrc_idees_data", "CO2_emissions_new.csv"), locale = locale(decimal_mark = "."))
CO2_emissions_new <- CO2_emissions_new %>% select("sector_id", "Industry", "to_node", "emission", "unit", `2025`, `2030`, `2040`, `2050`)

lifetime_new <- read_delim(here("input_data/processed_jrc_idees_data", "lifetime_new.csv"), locale = locale(decimal_mark = "."))
lifetime_original <- read_delim(here("input_data/processed_jrc_idees_data", "lifetime_original.csv"), locale = locale(decimal_mark = "."))

capex_new <- read_delim(here("input_data/processed_jrc_idees_data", "capex_new.csv"), locale = locale(decimal_mark = "."))
capex_new <- capex_new  %>%
  select(sector_id, Industry, to_node, costs, unit, `2025`, `2030`, `2040`, `2050`)

opex_new<- read_delim(here("input_data/processed_jrc_idees_data", "opex_new.csv"), locale = locale(decimal_mark = "."))
opex_new <- opex_new  %>%
  select(sector_id, Industry, to_node, costs, unit, `2025`, `2030`, `2040`, `2050`)

steel_finishing_energy_new <- read_delim(here("input_data/processed_jrc_idees_data", "steel_finishing_new_energy_out.csv"), locale = locale(decimal_mark = "."))
steel_finishing_energy_new <- steel_finishing_energy_new  %>%
  select("sector_id", "to_node", "unit", "Industry", "from_node",
         `2025`, `2030`, `2040`, `2050`)

steel_finishing_CO2_new <- read_delim(here("input_data/processed_jrc_idees_data", "steel_finishing_new_CO2_out.csv"), locale = locale(decimal_mark = "."))
steel_finishing_CO2_new <- steel_finishing_CO2_new %>%
  select("sector_id", "to_node", "unit", "Industry",
         `2025`, `2030`, `2040`, `2050`) %>%
   mutate(emission = "co2_emission")

steel_finishing_lifetime_new <- read_delim(here("input_data/processed_jrc_idees_data", "lifetime_steel_finishing_new.csv"), locale = locale(decimal_mark = "."))

steel_finishing_energy_original <- read_delim(here("input_data/processed_jrc_idees_data","steel_finishing_original_energy_out.csv"), locale = locale(decimal_mark = "."))
steel_finishing_energy_original <- steel_finishing_energy_original %>%
  select("sector_id", "to_node", "unit", "Industry", "from_node",
         `2025`, `2030`, `2040`, `2050`)

steel_finishing_CO2_original <- read_delim(here("input_data/processed_jrc_idees_data","steel_finishing_original_CO2_out.csv"), locale = locale(decimal_mark = "."))
steel_finishing_CO2_original <- steel_finishing_CO2_original %>%
  select("sector_id", "to_node", "unit", "Industry",
         `2025`, `2030`, `2040`, `2050`) %>%
   mutate(emission = "co2_emission")

steel_finishing_lifetime_original <- read_delim(here("input_data/processed_jrc_idees_data", "lifetime_steel_finishing_original.csv"), locale = locale(decimal_mark = "."))

capex_steel_new <- read_delim(here("input_data/processed_jrc_idees_data", "capex_steel_new.csv"), locale = locale(decimal_mark = "."))
capex_steel_new <- capex_steel_new  %>%
  select(sector_id, Industry, to_node, costs, unit, `2025`, `2030`, `2040`, `2050`)

opex_steel_new<- read_delim(here("input_data/processed_jrc_idees_data", "opex_steel_new.csv"), locale = locale(decimal_mark = "."))
opex_steel_new <- opex_steel_new  %>%
  select(sector_id, Industry, to_node, costs, unit, `2025`, `2030`, `2040`, `2050`)



prod_vol_cap_2018year <- bind_rows(prod_vol_cap_2018year, production_original)
prod_vol_cap_allyear <- bind_rows(prod_vol_cap_allyear, production_new)

costs_capex_perton_all <- bind_rows(costs_capex_perton_all, capex_new)
costs_fom_perton_all <- bind_rows(costs_fom_perton_all, opex_new)
costs_capex_perton_all <- bind_rows(costs_capex_perton_all, capex_steel_new)
costs_fom_perton_all <- bind_rows(costs_fom_perton_all, opex_steel_new)

sec_perton_all <- bind_rows(sec_perton_all,proces_energy_original)
sec_perton_all <- bind_rows(sec_perton_all,proces_energy_new)
sec_perton_all <- bind_rows(sec_perton_all,steel_finishing_energy_new)
sec_perton_all <- bind_rows(sec_perton_all,steel_finishing_energy_original)

emission_co2_emission_perton_all <- bind_rows(emission_co2_emission_perton_all,CO2_emissions_original)
emission_co2_emission_perton_all <- bind_rows(emission_co2_emission_perton_all,CO2_emissions_new)
emission_co2_emission_perton_all <- bind_rows(emission_co2_emission_perton_all,steel_finishing_CO2_new)
emission_co2_emission_perton_all <- bind_rows(emission_co2_emission_perton_all,steel_finishing_CO2_original)

life_prodroute_all <- bind_rows(life_prodroute_all,lifetime_new) 
life_prodroute_all <- bind_rows(life_prodroute_all,lifetime_original) 
life_prodroute_all <- bind_rows(life_prodroute_all,steel_finishing_lifetime_new) 
life_prodroute_all <- bind_rows(life_prodroute_all,steel_finishing_lifetime_original) 

```


## writing all data in an excel workbook

Save technology catalogue data to excel workbook.

### Creating output directory

```{r}
output_dir <- here('outputs', 'technology_catalogue')

if (!dir.exists(output_dir)){
  print("Output directory doesn't exist. Creating a new one!")
dir.create(output_dir)
} else {
    print("Output directory already exists. Not creating a new one!")
}
```

### Writing final Excel workbook

```{r}

write_xlsx(list('ind_production_2018_nuts3' = prod_vol_cap_2018year_nuts3,
                'ind_production_30_50_nuts3' = prod_vol_cap_allyear_nuts3,
                'ind_production_2018_nuts0' = prod_vol_cap_2018year,
                'ind_production_30_50_nuts0' = prod_vol_cap_allyear,
                'ind_process_routes_sec' = sec_perton_all,
                'ind_process_route_life' = life_prodroute_all, 
                'ind_process_routes_co2_capture' = emission_co2_capture_perton_all,
                'ind_process_routes_co2_emission' = emission_co2_emission_perton_all,
                'ind_process_routes_capex' = costs_capex_perton_all,
                'ind_process_routes_fom' = costs_fom_perton_all),
           here(output_dir, 'technology_catalogue_ind_nuts0_nuts3.xlsx'))
```

### Filter out all data except HC, MeOH and NH3 + save excel file

```{r}
#filter out all data but HC, MeOH and NH3 from data + save in excel
prod_vol_cap_2018year_nuts3_no_HC_NH3 <- prod_vol_cap_2018year_nuts3 |> filter(!to_node %in% c("HC", "fertiliser-ammonia-NH3"))
prod_vol_cap_allyear_nuts3_no_HC_NH3  <- prod_vol_cap_allyear_nuts3 |> filter(!to_node %in% c("HC", "fertiliser-ammonia-NH3"))
prod_vol_cap_2018year_no_HC_NH3 <- prod_vol_cap_2018year |> filter(!to_node %in% c("HC", "fertiliser-ammonia-NH3"))
prod_vol_cap_allyear_no_HC_NH3 <- prod_vol_cap_allyear |> filter(!to_node %in% c("HC", "fertiliser-ammonia-NH3"))
sec_perton_all_no_HC_NH3 <- sec_perton_all |> filter(!to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3"))
life_prodroute_all_no_HC_NH3 <- life_prodroute_all |> filter(!to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3"))
emission_co2_capture_perton_all_no_HC_NH3 <- emission_co2_capture_perton_all |> filter(!to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3"))
emission_co2_emission_perton_all_no_HC_NH3 <- emission_co2_emission_perton_all |> filter(!to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3"))
costs_capex_perton_all_no_HC_NH3 <- costs_capex_perton_all |> filter(!to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3"))
costs_fom_perton_all_no_HC_NH3 <- costs_fom_perton_all |> filter(!to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3"))

write_xlsx(list('ind_production_2018_nuts3' = prod_vol_cap_2018year_nuts3_no_HC_NH3,
                'ind_production_30_50_nuts3' = prod_vol_cap_allyear_nuts3_no_HC_NH3,
                'ind_production_2018_nuts0' = prod_vol_cap_2018year_no_HC_NH3,
                'ind_production_30_50_nuts0' = prod_vol_cap_allyear_no_HC_NH3,
                'ind_process_routes_sec' = sec_perton_all_no_HC_NH3,
                'ind_process_route_life' = life_prodroute_all_no_HC_NH3, 
                'ind_process_routes_co2_capture' = emission_co2_capture_perton_all_no_HC_NH3,
                'ind_process_routes_co2_emission' = emission_co2_emission_perton_all_no_HC_NH3,
                'ind_process_routes_capex' = costs_capex_perton_all_no_HC_NH3,
                'ind_process_routes_fom' = costs_fom_perton_all_no_HC_NH3),
           here(output_dir, 'technology_catalogue_ind_nuts0_nuts3_no_HC_NH3.xlsx'))
```

### Filter out HC, MeOH and NH3 (and convert ton NH3 to mwh) + save excel file

```{r}
#filter out HC, MeOH and NH3 from data + convert ton NH3 to mwh + save in excel
prod_vol_cap_2018year_nuts3_HC_NH3 <- prod_vol_cap_2018year_nuts3 |> 
  filter(to_node %in% c("HC", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         `2018` = ifelse(to_node == "NH3", `2018` * 5.54 * 1000, `2018`),
         unit = ifelse(to_node == "NH3", "mwh_yr", unit))

prod_vol_cap_allyear_nuts3_HC_NH3  <- prod_vol_cap_allyear_nuts3 |> 
  filter(to_node %in% c("HC", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         `2030` = ifelse(to_node == "NH3", `2030` * 5.54 * 1000, `2030`),
         `2050` = ifelse(to_node == "NH3", `2050` * 5.54 * 1000, `2050`),
         unit = ifelse(to_node == "NH3", "mwh_yr", unit))

prod_vol_cap_2018year_HC_NH3 <- prod_vol_cap_2018year |> 
  filter(to_node %in% c("HC", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         `2018` = ifelse(to_node == "NH3", `2018` * 5.54 * 1000, `2018`),
         unit = ifelse(to_node == "NH3", "mwh_yr", unit))

prod_vol_cap_allyear_HC_NH3 <- prod_vol_cap_allyear |> 
  filter(to_node %in% c("HC", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         `2030` = ifelse(to_node == "NH3", `2030` * 5.54 * 1000, `2030`),
         `2050` = ifelse(to_node == "NH3", `2050` * 5.54 * 1000, `2050`),
         unit = ifelse(to_node == "NH3", "mwh_yr", unit))

sec_perton_all_HC_NH3 <- sec_perton_all |> 
  filter(to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         to_node = ifelse(to_node == "HC-MeOH", "MeOH", to_node),
         `2025` = ifelse(to_node == "NH3", `2025` / 5.54, `2025`),
         `2030` = ifelse(to_node == "NH3", `2030` / 5.54, `2030`),
         `2040` = ifelse(to_node == "NH3", `2040` / 5.54, `2040`),
         `2050` = ifelse(to_node == "NH3", `2050` / 5.54, `2050`),
         unit = ifelse(to_node == "NH3", "mwh_mwh", unit))

life_prodroute_all_HC_NH3 <- life_prodroute_all |> 
  filter(to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         to_node = ifelse(to_node == "HC-MeOH", "MeOH", to_node))

emission_co2_capture_perton_all_HC_NH3 <- emission_co2_capture_perton_all |> 
  filter(to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         to_node = ifelse(to_node == "HC-MeOH", "MeOH", to_node),
         `2025` = ifelse(to_node == "NH3", `2025` / 5.54, `2025`),
         `2030` = ifelse(to_node == "NH3", `2030` / 5.54, `2030`),
         `2040` = ifelse(to_node == "NH3", `2040` / 5.54, `2040`),
         `2050` = ifelse(to_node == "NH3", `2050` / 5.54, `2050`),
         unit = ifelse(to_node == "NH3", "tco2_mwh", unit))

emission_co2_emission_perton_all_HC_NH3 <- emission_co2_emission_perton_all |> 
  filter(to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         to_node = ifelse(to_node == "HC-MeOH", "MeOH", to_node),
         `2025` = ifelse(to_node == "NH3", `2025` / 5.54, `2025`),
         `2030` = ifelse(to_node == "NH3", `2030` / 5.54, `2030`),
         `2040` = ifelse(to_node == "NH3", `2040` / 5.54, `2040`),
         `2050` = ifelse(to_node == "NH3", `2050` / 5.54, `2050`),
         unit = ifelse(to_node == "NH3", "tco2_mwh", unit))

costs_capex_perton_all_HC_NH3 <- costs_capex_perton_all |> 
  filter(to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         to_node = ifelse(to_node == "HC-MeOH", "MeOH", to_node),
         `2025` = ifelse(to_node == "NH3", `2025` / 5.54, `2025`),
         `2030` = ifelse(to_node == "NH3", `2030` / 5.54, `2030`),
         `2040` = ifelse(to_node == "NH3", `2040` / 5.54, `2040`),
         `2050` = ifelse(to_node == "NH3", `2050` / 5.54, `2050`),
         unit = ifelse(to_node == "NH3", "eur-yr_mwh", unit))

costs_fom_perton_all_HC_NH3 <- costs_fom_perton_all |> 
  filter(to_node %in% c("HC", "HC-MeOH", "fertiliser-ammonia-NH3")) |> 
  mutate(to_node = ifelse(to_node == "fertiliser-ammonia-NH3", "NH3", to_node),
         to_node = ifelse(to_node == "HC-MeOH", "MeOH", to_node),
         `2025` = ifelse(to_node == "NH3", `2025` / 5.54, `2025`),
         `2030` = ifelse(to_node == "NH3", `2030` / 5.54, `2030`),
         `2040` = ifelse(to_node == "NH3", `2040` / 5.54, `2040`),
         `2050` = ifelse(to_node == "NH3", `2050` / 5.54, `2050`),
         unit = ifelse(to_node == "NH3", "eur_mwh", unit))

write_xlsx(list('ind_production_2018_nuts3' = prod_vol_cap_2018year_nuts3_HC_NH3,
                'ind_production_30_50_nuts3' = prod_vol_cap_allyear_nuts3_HC_NH3,
                'ind_production_2018_nuts0' = prod_vol_cap_2018year_HC_NH3,
                'ind_production_30_50_nuts0' = prod_vol_cap_allyear_HC_NH3,
                'ind_process_routes_sec' = sec_perton_all_HC_NH3,
                'ind_process_route_life' = life_prodroute_all_HC_NH3, 
                'ind_process_routes_co2_capture' = emission_co2_capture_perton_all_HC_NH3,
                'ind_process_routes_co2_emission' = emission_co2_emission_perton_all_HC_NH3,
                'ind_process_routes_capex' = costs_capex_perton_all_HC_NH3,
                'ind_process_routes_fom' = costs_fom_perton_all_HC_NH3),
           here(output_dir, 'technology_catalogue_ind_nuts0_nuts3_HC_NH3.xlsx'))
```